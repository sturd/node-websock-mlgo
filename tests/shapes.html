<html>
	<head>
		<title>Shapes Test</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			#c{foreground-color:#333;background-color:#444;position:relative;height:480px;width:640px;}
		</style>
	</head>
	<body>
		<canvas id="c" width="640" height="480">Your browser does not support the HTML5 feature; canvas.</canvas>
		<script type="text/javascript">

			var KEY_LEFT = 37;
			var KEY_UP = 38;
			var KEY_RIGHT = 39;
			var KEY_DOWN = 40;
			

			// START USER DATA *************************************************
			// TODO: Refactor code to user object for game

			var xPos = 50; var yPos = 400;
			var xVel = 0; var yVel = 0;
			var rotation = 90;
			// END USER DATA   *************************************************
	
			var cnvCxt;
			var conn;
			var key = [];
			$( function()
			{
				keyInit();
				cnvCxt = document.getElementById( "c" ).getContext( '2d' );
				cnvCxt.fillStyle = "rgb( 1, 1, 1 )";

				if( window.WebSocket )
				{
					conn = new WebSocket( "ws://localhost:1987/" );
					conn.onopen = function()
					{
						setInterval( draw, 1000 / 30 );
						conn.send( "nCraigy-test" );
					}
				}
			} );

			function keyInit()
			{
				document.onkeydown = function( e )
				{
					key[ e.keyCode ] = true;
				}

				document.onkeyup = function( e )
				{
					key[ e.keyCode ] = false;
				}
			}

			function draw()
			{
				cnvCxt.clearRect( 0, 0, 640, 480 );

				cnvCxt.save();
				cnvCxt.translate( xPos + 16, yPos + 28 );
				cnvCxt.rotate( rotation * ( Math.PI / 180 ) );
				cnvCxt.translate( -( xPos + 16 ), -( yPos + 28 ) );
				cnvCxt.fillRect( xPos, yPos, 32, 56 );
				cnvCxt.restore();

				conn.send( "x" + xPos + "y" + yPos +
						   "r" + rotation +
						   "i0j0" );				

				// Steering Detection
				if( key[ KEY_LEFT ] )
				{
					rotation -= 3;
				}
				else if( key[ KEY_RIGHT ] )
				{
					rotation += 3;
				}

				var xTmp = 0.5 * Math.sin( rotation * ( Math.PI / 180 ) );
				var yTmp = 0.5 * Math.cos( rotation * ( Math.PI / 180 ) );
				// Accelerate/decelerate
				if( key[ KEY_UP ] )
				{
					yVel -= yTmp;
					xVel += xTmp;
				}

				else if( !key[ KEY_UP ] )
				{
					if( yVel < 0 )
					{
						if( yVel > yTmp )
							yVel = 0;

							else
								yVel += yTmp;
					}
						else if( yVel > 0 )
						{
							if( yVel < yTmp )
								yVel = 0;

								else
									yVel -= yTmp;
						}

					if( xVel > 0 )
					{
						if( xVel < xTmp )
							xVel = 0;

							else
								xVel -= xTmp;
					}
						else if( xVel < 0 )
						{
							if( xVel > xTmp )
								xVel = 0;

								else
									xVel -= xTmp;
						}
				}

				yPos += yVel;
				xPos += xVel;
			}
		</script>
	</body>
</html>
